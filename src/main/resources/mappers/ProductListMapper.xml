<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.ProductListMapper">

    <select id="selectProductsByCategoryWithChildren"
        resultType="com.itwillbs.dto.ProductListByCategoryDTO">

    SELECT
        p.product_id           AS productId,
        p.product_name         AS title,
        p.price                AS price,
        p.main_image_url       AS thumbnailUrl,
        p.region_display_name  AS regionName,

        -- ğŸ”¥ ì°œ ê°œìˆ˜ (DB ë‹¨ì¼ ì§„ì‹¤)
        (
            SELECT COUNT(*)
            FROM user_favorites uf
            WHERE uf.product_id = p.product_id
        ) AS likeCount,

        -- ğŸ”¥ ë‚´ê°€ ì°œí–ˆëŠ”ì§€
        EXISTS (
            SELECT 1
            FROM user_favorites uf
            WHERE uf.product_id = p.product_id
              AND uf.user_id = 1
        ) AS liked,

        p.created_at           AS createdTime

    FROM products p
    JOIN categories c
      ON p.category_id = c.category_id
    WHERE c.category_id = #{categoryId}
       OR c.parent_id = #{categoryId}
    ORDER BY p.created_at DESC

</select>


</mapper>