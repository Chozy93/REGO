<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.MainProductMapper">

    <!-- =========================
         ÏµúÍ∑º Îì±Î°ù ÏÉÅÌíà
         MAIN01_RECENT
    ========================= -->
    <select id="selectRecentProducts"
            resultType="com.itwillbs.dto.MainProductListDTO">

        SELECT
            p.product_id               AS productId,
            p.product_name             AS title,
            p.price                    AS price,
            p.main_image_url           AS thumbnailUrl,
            p.region_display_name      AS regionName,
            DATE_FORMAT(p.created_at, '%Y-%m-%d %H:%i') AS createdTime,

            /* ‚ù§Ô∏è Ï∞ú Í∞úÏàò */
            (
                SELECT COUNT(*)
                FROM user_favorites uf
                WHERE uf.product_id = p.product_id
            ) AS likeCount,

            /* ‚ù§Ô∏è ÎÇ¥Í∞Ä Ï∞úÌñàÎäîÏßÄ (ÏûÑÏãú user_id = 1) */
            EXISTS (
                SELECT 1
                FROM user_favorites uf
                WHERE uf.product_id = p.product_id
                  AND uf.user_id = 1
            ) AS liked

        FROM products p
        WHERE p.sales_status = 'ON_SALE'
        ORDER BY p.created_at DESC
        LIMIT 12

    </select>
    
    <!-- =========================
     ÏµúÍ∑º Îì±Î°ù ÏÉÅÌíà (Ï†ïÎ†¨)
     MAIN01_SORT_ORDER
========================= -->
<select id="selectRecentProductsWithSort"
        parameterType="map"
        resultType="com.itwillbs.dto.MainProductListDTO">

    SELECT
        p.product_id               AS productId,
        p.product_name             AS title,
        p.price                    AS price,
        p.main_image_url           AS thumbnailUrl,
        p.region_display_name      AS regionName,
        DATE_FORMAT(p.created_at, '%Y-%m-%d %H:%i') AS createdTime,

        /* ‚ù§Ô∏è Ï∞ú Í∞úÏàò */
        (
            SELECT COUNT(*)
            FROM user_favorites uf
            WHERE uf.product_id = p.product_id
        ) AS likeCount,

        /* ‚ù§Ô∏è ÎÇ¥Í∞Ä Ï∞úÌñàÎäîÏßÄ */
        EXISTS (
            SELECT 1
            FROM user_favorites uf
            WHERE uf.product_id = p.product_id
              AND uf.user_id = #{userId}
        ) AS liked

    FROM products p
    WHERE p.sales_status = 'ON_SALE'
    
    <choose>
        <!-- ÏµúÏã†Ïàú -->
        <when test="sort == 'recent'">
            ORDER BY p.created_at DESC
        </when>

        <!-- Ï∞ú ÎßéÏùÄ Ïàú -->
        <when test="sort == 'like'">
            ORDER BY likeCount DESC, p.created_at DESC
        </when>

        <!-- Ï°∞Ìöå ÎßéÏùÄ Ïàú -->
        <when test="sort == 'view'">
            ORDER BY p.view_count DESC, p.created_at DESC
        </when>

        <!-- Í∏∞Î≥∏Í∞í -->
        <otherwise>
            ORDER BY p.created_at DESC
        </otherwise>
    </choose>

    LIMIT 12
</select>


    <!-- =========================
         Ïù∏Í∏∞ ÏÉÅÌíà
         MAIN01_POPULAR
    ========================= -->
    <select id="selectPopularProducts"
        resultType="com.itwillbs.dto.MainProductListDTO">

    SELECT
        p.product_id               AS productId,
        p.product_name             AS title,
        p.price                    AS price,
        p.main_image_url           AS thumbnailUrl,
        p.region_display_name      AS regionName,
        DATE_FORMAT(p.created_at, '%Y-%m-%d %H:%i') AS createdTime,

        /* üëÅ Ï°∞ÌöåÏàò */
        p.view_count               AS viewCount,

        /* ‚ù§Ô∏è Ï∞ú Í∞úÏàò */
        (
            SELECT COUNT(*)
            FROM user_favorites uf
            WHERE uf.product_id = p.product_id
        ) AS likeCount,

        /* ‚ù§Ô∏è ÎÇ¥Í∞Ä Ï∞úÌñàÎäîÏßÄ (ÏûÑÏãú user_id = 1) */
        EXISTS (
            SELECT 1
            FROM user_favorites uf
            WHERE uf.product_id = p.product_id
              AND uf.user_id = 1
        ) AS liked

    FROM products p
    WHERE p.sales_status = 'ON_SALE'

    ORDER BY
        p.view_count DESC,
        likeCount DESC,
        p.created_at DESC

    LIMIT 12

</select>


</mapper>
